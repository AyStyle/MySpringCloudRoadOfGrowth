# MySpringCloudRoundOfGrowth
## 第一部分 微服务架构
### 第1节 互联网应用架构发展
### 第2节 微服务架构体现的思想及优缺点
```
   微服务架构设计的核心思想就是**“微”**，拆分的粒度相对比较小，
这样的话单一职责、开发的耦合度就会降低、微小的功能可以独立部署
扩展、灵活性强，升级改造影响范围小。
```
+ 优点：
   1. 便于特定业务功能聚焦
   2. 每个微服务都可以被一个小团队单独实施（开发、测试、部署上线、运维），
      团队合作一定程度解耦，便于实施敏捷开发
   3. 便于重用和模块之间的组装
   4. 微服务很独立，不同的微服务可以使用不同的语言开发，松耦合
   5. 微服务架构下，更容易引入新技术
   6. 更好的实现DevOps开发运维一体化

+ 缺点：
   1. 分布式复杂难以管理，当服务数量增加，管理将越加复杂
   2. 分布式链路跟踪难等
  
### 第3节 微服务架构中的一些概念
1. 服务注册：
   ```
      服务提供者将所提供的服务信息（服务器IP和端口、服务访问协议等）注册/等级到注册中心
   ```

2. 服务发现：
   ```
      服务消费者能够从注册中心获取到较为实时的服务列表，然后根据一定的策略选择一个服务访问
   ```
   
3. 负载均衡：
   ```
      负责均衡即将请求压力分配到多个服务器（应用服务器、数据库服务器等），以此来提高服务的性能、可靠性
   ```

4. 熔断：
   ```
      熔断即断路保护。微服务架构中，如果下游服务因访问压力过大而响应变慢或失败，上游服务为了保护
   系统整体可用性，可以暂时切断对下游服务的调用。这种牺牲局部，保全整体的措施就叫做熔断。
   ```

5. 链路追踪：
   ```
      链路追踪就是对一次请求涉及的很多个服务链路进行日志记录、性能监控
   ```
   
6. API网关：
   1. 统一接入（路由）
   2. 安全防护（统一鉴权，负责网关访问身份认证验证，与“访问认证中心”通信，实际认证业务逻辑交移“访问认证中心处理”）
   3. 黑白名单（实现通过IP地址控制禁止访问网关功能，控制访问）
   4. 协议适配（实现通信协议检验、适配转换的功能）
   5. 流量管控（限流）
   6. 长短链接支持
   7. 容错能力（负载均衡）
   ```
      功能：
   ```

## 第二部分
### 第1节 Spring Cloud是什么
```
   Spring Cloud是一系列框架的有序集合。
   开发服务、发现注册、配置中心、消息总线、负载均衡、断路器、数据监控等。
   利用Spring Boot的开发便利性简化了微服务架构的开发（自动装配）。
```

### 第2节 Spring Cloud解决了什么问题
```
   Spring Cloud规范及实现意图要解决的问题其实就是微服务架构实施过程中存在的一些问题
```

### 第3节 Spring Cloud架构

|组件|第一代Spring Cloud（Netflix，SCN）|第二代Spring Cloud（Alibaba，SCA）|
|:---:|:---|:---|
|注册中心|Netflix Eureka|Alibaba Nacos|
|负载均衡|Netflix Ribbon|Alibaba Dubbo LB、Spring Cloud Loadbalancer|
|熔断器|Netflix Hystrix|Alibaba Sentinel|
|网关|Netflix Zuul（废弃）|Spring Cloud Gateway|
|配置中心|Spring Cloud Config|Alibaba Nacos、携程Apollo|
|服务调用|Netflix Feign|Alibaba Dubbo RPC|
|消息驱动|Spring Cloud Stream|Spring Cloud Stream|
|链路追踪|Spring Cloud Sleuth/Zipkin|Spring Cloud Sleuth/Zipkin|

## 第四部分 - 第一代Spring Cloud核心组件
### 第一节 Eureka服务注册中心
#### 1.1 关于服务注册中心
```
注册中心本质上是为了解耦服务提供者和服务消费者。
注册中心需要完成服务提供者的健康监控，当发现服务提供者失效时需要及时剔除
```


##### 1.1.1 服务注册中心一般原理
1. 服务提供者启动
2. 服务提供者将相关服务信息主动注册到注册中心
3. 服务消费者获取服务注册信息：
   1. poll模式：服务消费者可以主动拉取可用的服务提供者清单（Eureka团队不再更新，也没有后续 ）
   2. push模式：服务消费者订阅服务（当服务提供者有变化时，注册中心也会主动推送更新后的服务清单给消费者）
4. 服务消费者直接调用服务提供者
   
##### 1.1.3 主流服务中心对比
|组件名|语言|CAP|对外暴露接口|
|:---:|:---:|:---:|:---:|
|Eureka|Java|AP（自我保护机制，保证可用）|HTTP|
|Consul|Go|CP|HTTP/DNS|
|Zookeeper|Java|CP|客户端|
|Nacos|Java|支持AP/CP切换|HTTP|

#### 1.2 服务注册中心组件 Eureka
```
Eureka通过心跳检测、健康检查和客户端缓存机制，提高系统的灵活性、可伸缩性和可用性
```

#### 1.4 Eureka元数据
1. 标准元数据：
   ```
   主机名、IP、端口号等信息，这些信息都会被发布在服务注册表中，用于服务之间的调用。
   ```
2. 自定义元数据：
   ```
   可以使用eureka.instance.metadata-map配置，符合Key/Value的存储格式。
   这些元数据可以在远程客户端中访问。
   ```

##### 1.4.2 Eureka客户端详解
服务提供者（Eureka客户端）要向EurekaServer注册服务，并完成服务续约等工作

+ 服务注册详解
   ```
   1. 导入了EurekaClient依赖坐标，配置Eureka服务注册中心地址
   2. 服务在启动时向注册中心发起注册请求，携带服务元数据信息
   3. Eureka注册中心把服务的信息保存到Map中
   ```
 
+ 服务续约详解
   ```
   服务每隔30秒会向注册中心续约（心跳）一次，如果没有续约，那么租约在90秒后到期，
   然后服务会被失效。每隔30秒的续约操作称之为心跳检测
   ```

+ 获取服务列表详解
   ```
   1. 服务消费者启动时，从EurekaServer服务列表获取只读备份，缓存到本地
   2. 每隔30秒，重新获取并更新数据
   ```   
  
##### 1.4.3 Eureka服务端详解
+ 服务下线
   ```
   1. 当服务正常关闭操作时，会发送服务下线的REST请求给EurekaServer
   2. 服务中心接受到请求后，将该服务置为下线状态
   ```
  
+ 失效剔除
   ```
   Eureka Server会定时检测（默认60秒），如果发现实例在一定时间内没有收到心跳，
   则会注销此实例
   ```

+ 自我保护
   ```
   如果在15分钟内超过85%的客户端节点都没有正常的心跳，那么Eureka就认为客户端
   与注册中心出现了网络故障，Eureka Server自动进入自我保护机制
  
   当处于自我保护模式时：
      1. 不会剔除任何服务实例（可能是服务提供者和EurekaServer之间网络问题），
         保证了大多数服务依然可用
      2. Eureka Server仍然能够接受新服务的注册和查询请求，但是不会被同步到
         其它节点上，保证当前节点依然可用，当网络稳定时，当前Eureka Server
         新的注册信息会被同步到其它节点上
      3. 通过eureka.server.enable-self-preservation配置自我保护模式，默认开
   ```

### 第二节 Ribbon负载均衡
#### 2.1 负载均衡
负载均衡一般分为服务器端负载均衡和客户端负载均衡

+ 服务器端负载均衡：
   ```
   Nginx、F5，请求到达服务器之后由这些负载均衡器根据一定的算法将请求路由到目标服务器处理
   ```

+ 客户端负载均衡：
   ```
   Ribbon，服务消费者客户端会有一个服务器地址列表，调用方在请求前通过一定的负载均衡算法
   选择一个服务器进行访问，负载均衡算法的执行是在请求客户端进行。
  
   Ribbon是Netflix发布的负载均衡器。Eureka一般配合Ribbon进行使用，Ribbon利用从Eureka
   中读取到的服务信息，在调用服务提供者提供的服务时，会根据一定的算法进行负载均衡。
   ```

### 第三节 Hystrix熔断器
```
属于一种容错机制
```

#### 3.1 微服务中的雪崩效应
```
雪崩：
   下游链路崩溃，导致上游链路奔溃，最后系统崩溃就是雪崩效应

扇入：
   上游对自身的调用叫做扇入
扇入数：
   代表自身被调用的次数，扇入数越大，则：说明该模块复用性越好

扇出：
   自身对下游的调用叫做扇出
扇出数：
   代表自身调用下游微服务的个数，扇出数月大，则：说明业务逻辑越复杂

扇入数大是好事，扇出数大不一定是好事
``` 

#### 3.2 雪崩效应的解决方案 
+ 服务熔断
  ```
  当扇出链路的某个微服务不可用或者响应时间太长时，熔断该节点微服务的调用，
  进行服务降级，并快速返回错误的响应信息。当检测到该节点微服务调用响应正
  常后，恢复调用链路。
  
  注意：
     1. 服务熔断重点在"断"，切断对下游服务的调用
     2. 服务熔断和服务降级往往是一起使用的，Hystrix就是这样
  ```
  
+ 服务降级
  ```
  通俗讲就是整体资源不够用了，先将一些不重要的服务停掉（调用的时候返回一个默认值，兜底数据）
  待渡过高峰期后，再把服务打开。这样做的好处，虽然整体服务水平下降，但是比不可用要强。
  ```
  
+ 服务限流
  ```
  服务限流是资源不够用，但服务不能停，这个时候使用服务限流来限制这些场景的并发/请求量
  
  限流措施：
     1. 限制总并发数（比如数据库连接池、线程池）
     2. 限制瞬时并发数（如果NGINX限制瞬时并发连接数）
     3. 限制时间窗口内的平均速率（如Guava的RateLimiter、nginx的limit_req模块，限制每秒的平均速率）
     4. 限制远程接口调用速率、限制MQ的消费速率等
  ```

#### 3.3 Hystrix简介 
```
   Hystrix是Netflix开源的一个延迟和容错库，用于隔离访问远程系统、
服务或者第三方库，防止级联失败从而提升系统的可用性与容错性。

Hystrix主要通过以下几点实现延迟和容错：
   1. 包裹请求：使用HystrixCommand包裹对依赖的调用逻辑。
   2. 跳闸机制：当某服务的错误率超过一定的阈值时，Hystrix可以跳闸，停止请求该服务一段时间。
   3. 资源隔离（舱壁模式）：Hystrix为每个依赖都维护了一个小型的线程池（或者信号量）。如果该线程池已满，发往该依赖的请求就被立即拒绝，而不是排队等待，从而加速失败判定。
   4. 监控：Hystrix可以近乎实时地监控运行指标和配置的变化，例如：成功、失败、超时以及被拒绝的请求等。
   5. 回退机制：当请求失败、超时、被拒绝，或当断路器打开时，执行回退逻辑。回退逻辑由开发人员自行提供，例如返回一个缺省值。
   6. 自我修复：断路器打开一段时间后，会自动进入“半开”状态。
```

### 第四节 Feign远程调用组件
#### 4.1 Feign简介
```
   Feign是Netflix开发的一个轻量级RESTful的HTTP服务客户端，是以Java接口注解的方式调用Http请求，
而不用像Java中通过封装Http请求报文的方式直接调用，Feign被广泛的应用到SpringCloud的解决方案中。

1. Feign可以帮助我们更加便捷、优雅的调用HTTP API：在SpringCloud中，使用Feign非常简单，
   创建一个接口，并在接口上添加一些注解，代码就完成了
2. SpringCloud对Feign进行了增强，使Feign支持了SpringMVC注解

本质：封装了Http调用流程，更符合面向接口化的编程习惯，类似于Dubbo的服务调用

Feign = RestTemplate + Ribbon + Hystrix
``` 

### 第五节 GateWay网关组件
```
网关：微服务中的重要组成部分，Spring Cloud GateWay只是众多网关解决方案中的一种
```
#### 5.1 Gateway简介
```
   Spring Cloud GateWay是Spring Cloud的一个全新项目，目标是取代Netflix Zuul。
它基于Spring5.0 + SpringBoot2.0 + WebFlux（基于高性能的Reactor模式响应式通信框架Netty，
异步非阻塞等模型）等技术开发，性能高于Zuul。官方测试GateWay是Zuul的1.6倍，旨在为微服务
架构提供一种简单有效的统一的API路由管理方式。

   Spring Cloud GateWay不仅仅提供统一的路由方式（反向代理），并且基于Filter链的方式提供了
网关基本的功能，例如：鉴权、流量控制、熔断、路径重写、日志监控等
```

#### 5.2 GateWay核心概念
```
   Spring Cloud GateWay基于Reactor，天生就是异步非阻塞的

   网关根据一定的条件匹配请求，匹配成功之后将请求转发到指定的服务地址。
而在转发的过程中，我们可以进行一些比较具体的控制（限流、日志、黑白名单）

GateWay核心逻辑：路由转发 + 执行过滤器链
```

+ 路由（route）：
  ```
     网关最基础的部分，也是网关比较基础的工作单元。路由由一个ID、一个目标URL（最终路由到的地址）、
  一系列的断言（匹配条件判断）和Filter过滤器（精细化控制）组成。如果断言为true，则：匹配该路由。
  ```

+ 断言（predicates）：
  ```
     参考了Java8中的断言java.util.function.Predicate，开发人员可以匹配Http请求中的所有内容
  （包括请求头、请求参数等。与NGINX中的location匹配一样），如果断言与请求相匹配，则：路由
  ```
  
+ 过滤器（filter）：
  ```
    一个标准的Spring WebFilter，使用过滤器，可以在请求之前或之后执行业务逻辑。
  ```